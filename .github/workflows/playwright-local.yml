name: Playwright Tests (Local XAMPP - Port 8081)

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests on XAMPP
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display configuration
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Configuration:" -ForegroundColor Cyan
          Write-Host "BASE_URL from secret: $env:BASE_URL" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
        env:
          BASE_URL: ${{ secrets.BASE_URL }}

      - name: Check XAMPP Apache
        shell: powershell
        run: |
          $apache = Get-Process -Name "httpd" -ErrorAction SilentlyContinue
          if ($apache) {
            Write-Host "✅ Apache is running"
            
            # Vérifier les ports
            $connections = Get-NetTCPConnection -State Listen | Where-Object { $_.OwningProcess -in $apache.Id }
            Write-Host "Apache listens on ports:"
            $connections | ForEach-Object { Write-Host "  - $($_.LocalPort)" }
          } else {
            Write-Error "❌ Apache is not running"
            exit 1
          }

      - name: Test OrangeHRM accessibility
        shell: powershell
        run: |
          $url = $env:BASE_URL
          
          if (-not $url) {
            Write-Host "⚠️  BASE_URL secret not set, using default"
            $url = "http://localhost:8081/orangehrm-5.7/web/index.php/auth/login"
          }
          
          Write-Host "Testing URL: $url" -ForegroundColor Yellow
          
          try {
            $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10 -ErrorAction Stop
            Write-Host "✅ SUCCESS! OrangeHRM is accessible" -ForegroundColor Green
            Write-Host "Status Code: $($response.StatusCode)" -ForegroundColor Green
          } catch {
            Write-Host "❌ FAILED to access OrangeHRM" -ForegroundColor Red
            Write-Host "URL tested: $url" -ForegroundColor Yellow
            Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
            
            # Diagnostic supplémentaire
            Write-Host "`nTrying alternative URLs..." -ForegroundColor Yellow
            $alternatives = @(
              "http://localhost:8081",
              "http://localhost:8081/orangehrm-5.7",
              "http://localhost/orangehrm-5.7/web/index.php/auth/login",
              "http://localhost:80/orangehrm-5.7/web/index.php/auth/login"
            )
            
            foreach ($alt in $alternatives) {
              try {
                $r = Invoke-WebRequest -Uri $alt -UseBasicParsing -TimeoutSec 3 -ErrorAction Stop
                Write-Host "  ✅ $alt works!" -ForegroundColor Green
              } catch {
                Write-Host "  ❌ $alt failed" -ForegroundColor Gray
              }
            }
            
            exit 1
          }
        env:
          BASE_URL: ${{ secrets.BASE_URL }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium

      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOCAL_USERNAME: ${{ secrets.LOCAL_USERNAME }}
          LOCAL_PASSWORD: ${{ secrets.LOCAL_PASSWORD }}
          ENV: local

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  publish-to-xray:
    name: Publish to Xray
    if: always()
    needs: [test]
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Prepare results
        shell: powershell
        run: |
          if (!(Test-Path "merged-results")) { 
            New-Item -ItemType Directory -Path "merged-results" 
          }
          if (Test-Path "test-results/junit.xml") {
            Copy-Item "test-results/junit.xml" "merged-results/junit.xml"
            Write-Host "✅ junit.xml ready for upload"
          } else {
            Write-Host "⚠️  No junit.xml found"
          }

      - name: Authenticate with Xray
        run: node scripts/xray-authenticate.js
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}

      - name: Upload to Xray
        run: node scripts/xray-upload.js
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          XRAY_TEST_PLAN_KEY: ${{ secrets.XRAY_TEST_PLAN_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
