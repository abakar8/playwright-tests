name: Test XAMPP Connection (Diagnostic)

on:
  workflow_dispatch:  # Manuel uniquement pour le moment
  push:
    branches: [ main ]

jobs:
  diagnostic:
    name: Diagnostic XAMPP
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: Afficher informations syst√®me
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "    DIAGNOSTIC COMPLET" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Computer: $env:COMPUTERNAME"
          Write-Host "User: $env:USERNAME"
          Write-Host "Directory: $PWD"
          Write-Host ""

      - name: V√©rifier Apache (httpd)
        shell: powershell
        run: |
          Write-Host "Checking Apache processes..." -ForegroundColor Yellow
          $apache = Get-Process -Name "httpd" -ErrorAction SilentlyContinue
          
          if ($apache) {
            Write-Host "‚úÖ Apache is running" -ForegroundColor Green
            Write-Host "   Processes found: $($apache.Count)"
            $apache | ForEach-Object { Write-Host "   - PID: $($_.Id)" }
          } else {
            Write-Host "‚ùå Apache is NOT running" -ForegroundColor Red
            Write-Host ""
            Write-Host "Attempting to start Apache..."
            
            if (Test-Path "C:\xampp\apache_start.bat") {
              Start-Process "C:\xampp\apache_start.bat" -NoNewWindow -Wait
              Start-Sleep -Seconds 5
              
              $apache = Get-Process -Name "httpd" -ErrorAction SilentlyContinue
              if ($apache) {
                Write-Host "‚úÖ Apache started successfully!" -ForegroundColor Green
              } else {
                Write-Host "‚ùå Failed to start Apache" -ForegroundColor Red
                Write-Host "Please start XAMPP manually before running this workflow"
              }
            }
          }
          Write-Host ""

      - name: V√©rifier MySQL (mysqld)
        shell: powershell
        run: |
          Write-Host "Checking MySQL processes..." -ForegroundColor Yellow
          $mysql = Get-Process -Name "mysqld" -ErrorAction SilentlyContinue
          
          if ($mysql) {
            Write-Host "‚úÖ MySQL is running" -ForegroundColor Green
            Write-Host "   PID: $($mysql.Id)"
          } else {
            Write-Host "‚ùå MySQL is NOT running" -ForegroundColor Red
            Write-Host ""
            Write-Host "Attempting to start MySQL..."
            
            if (Test-Path "C:\xampp\mysql_start.bat") {
              Start-Process "C:\xampp\mysql_start.bat" -NoNewWindow -Wait
              Start-Sleep -Seconds 5
              
              $mysql = Get-Process -Name "mysqld" -ErrorAction SilentlyContinue
              if ($mysql) {
                Write-Host "‚úÖ MySQL started successfully!" -ForegroundColor Green
              } else {
                Write-Host "‚ùå Failed to start MySQL" -ForegroundColor Red
              }
            }
          }
          Write-Host ""

      - name: V√©rifier les ports
        shell: powershell
        run: |
          Write-Host "Checking network ports..." -ForegroundColor Yellow
          
          # Port 80 (Apache)
          $port80 = Get-NetTCPConnection -LocalPort 80 -State Listen -ErrorAction SilentlyContinue
          if ($port80) {
            Write-Host "‚úÖ Port 80 is listening" -ForegroundColor Green
            $proc = Get-Process -Id $port80.OwningProcess -ErrorAction SilentlyContinue
            if ($proc) {
              Write-Host "   Process: $($proc.ProcessName) (PID: $($proc.Id))"
            }
          } else {
            Write-Host "‚ùå Port 80 is NOT listening" -ForegroundColor Red
          }
          
          # Port 3306 (MySQL)
          $port3306 = Get-NetTCPConnection -LocalPort 3306 -State Listen -ErrorAction SilentlyContinue
          if ($port3306) {
            Write-Host "‚úÖ Port 3306 is listening" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Port 3306 is NOT listening" -ForegroundColor Red
          }
          Write-Host ""

      - name: Chercher OrangeHRM
        shell: powershell
        run: |
          Write-Host "Looking for OrangeHRM installation..." -ForegroundColor Yellow
          
          $possiblePaths = @(
            "C:\xampp\htdocs\orangehrm-5.7",
            "C:\xampp\htdocs\orangehrm",
            "C:\xampp\htdocs\orangeHRM-5.7",
            "C:\xampp\htdocs\OrangeHRM-5.7",
            "C:\xampp\htdocs\orangeHRM",
            "C:\xampp\htdocs\OrangeHRM"
          )
          
          $found = $false
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              Write-Host "‚úÖ Found OrangeHRM at: $path" -ForegroundColor Green
              $found = $true
              
              # Lister quelques fichiers
              Write-Host "   Contents:"
              Get-ChildItem $path -Name | Select-Object -First 10 | ForEach-Object {
                Write-Host "   - $_"
              }
              
              # V√©rifier web/index.php
              if (Test-Path "$path\web\index.php") {
                Write-Host "   ‚úì web/index.php exists"
              }
              
              break
            }
          }
          
          if (-not $found) {
            Write-Host "‚ùå OrangeHRM not found" -ForegroundColor Red
            Write-Host "   Searched in:"
            foreach ($path in $possiblePaths) {
              Write-Host "   - $path"
            }
            
            # Lister htdocs
            Write-Host ""
            Write-Host "Contents of C:\xampp\htdocs:"
            if (Test-Path "C:\xampp\htdocs") {
              Get-ChildItem "C:\xampp\htdocs" -Directory | ForEach-Object {
                Write-Host "   - $($_.Name)"
              }
            }
          }
          Write-Host ""

      - name: Tester les URLs
        shell: powershell
        run: |
          Write-Host "Testing web access..." -ForegroundColor Yellow
          Write-Host ""
          
          $urls = @(
            "http://localhost",
            "http://localhost/",
            "http://localhost/dashboard",
            "http://localhost/orangehrm-5.7",
            "http://localhost/orangehrm-5.7/",
            "http://localhost/orangehrm-5.7/web",
            "http://localhost/orangehrm-5.7/web/index.php",
            "http://localhost/orangehrm-5.7/web/index.php/auth/login",
            "http://127.0.0.1/orangehrm-5.7",
            "http://127.0.0.1/orangehrm-5.7/web/index.php/auth/login"
            "http://localhost:8081/orangehrm-5.7/web/index.php/auth/login

          )
          
          $workingUrls = @()
          
          foreach ($url in $urls) {
            try {
              Write-Host "Testing: $url" -NoNewline
              $response = Invoke-WebRequest -Uri $url -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop
              
              Write-Host " ‚Üí ‚úÖ OK (Status: $($response.StatusCode))" -ForegroundColor Green
              $workingUrls += $url
              
            } catch {
              $errorMsg = $_.Exception.Message
              if ($errorMsg -match "404") {
                Write-Host " ‚Üí ‚ùå Not Found (404)" -ForegroundColor Yellow
              } elseif ($errorMsg -match "timed out") {
                Write-Host " ‚Üí ‚ùå Timeout" -ForegroundColor Red
              } else {
                Write-Host " ‚Üí ‚ùå $errorMsg" -ForegroundColor Red
              }
            }
          }
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          
          if ($workingUrls.Count -gt 0) {
            Write-Host "‚úÖ WORKING URLS FOUND:" -ForegroundColor Green
            foreach ($url in $workingUrls) {
              Write-Host "   $url" -ForegroundColor Green
            }
            Write-Host ""
            Write-Host "üí° Use this URL in your GitHub Secret 'BASE_URL':" -ForegroundColor Yellow
            Write-Host "   $($workingUrls[0])" -ForegroundColor White
          } else {
            Write-Host "‚ùå NO WORKING URLS FOUND" -ForegroundColor Red
            Write-Host ""
            Write-Host "Troubleshooting:"
            Write-Host "1. Make sure XAMPP Apache is running (green in Control Panel)"
            Write-Host "2. Try accessing http://localhost in your browser"
            Write-Host "3. Check Apache error log: C:\xampp\apache\logs\error.log"
          }
          
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Afficher les secrets configur√©s (masqu√©s)
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "GitHub Secrets configured:" -ForegroundColor Yellow
          
          if ($env:BASE_URL) {
            Write-Host "   ‚úÖ BASE_URL is set"
            Write-Host "      Value: $env:BASE_URL"
          } else {
            Write-Host "   ‚ùå BASE_URL is NOT set"
          }
          
          if ($env:LOCAL_USERNAME) {
            Write-Host "   ‚úÖ LOCAL_USERNAME is set"
          } else {
            Write-Host "   ‚ùå LOCAL_USERNAME is NOT set"
          }
          
          if ($env:LOCAL_PASSWORD) {
            Write-Host "   ‚úÖ LOCAL_PASSWORD is set"
          } else {
            Write-Host "   ‚ùå LOCAL_PASSWORD is NOT set"
          }
          
          if ($env:JIRA_EMAIL) {
            Write-Host "   ‚úÖ JIRA_EMAIL is set"
          } else {
            Write-Host "   ‚ùå JIRA_EMAIL is NOT set"
          }
          
          if ($env:JIRA_API_TOKEN) {
            Write-Host "   ‚úÖ JIRA_API_TOKEN is set"
          } else {
            Write-Host "   ‚ùå JIRA_API_TOKEN is NOT set"
          }
          
          Write-Host ""
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOCAL_USERNAME: ${{ secrets.LOCAL_USERNAME }}
          LOCAL_PASSWORD: ${{ secrets.LOCAL_PASSWORD }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: R√©sum√© final
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "    R√âSUM√â DU DIAGNOSTIC" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Si tout est ‚úÖ vert ci-dessus, vous √™tes pr√™t !" -ForegroundColor Green
          Write-Host ""
          Write-Host "Prochaines √©tapes:"
          Write-Host "1. Notez l'URL qui fonctionne"
          Write-Host "2. Configurez-la dans GitHub Secrets ‚Üí BASE_URL"
          Write-Host "3. Lancez le workflow complet de tests"
          Write-Host ""