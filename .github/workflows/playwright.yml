name: Playwright Tests with Xray (Jira API Token)

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1-5'

env:
  NODE_VERSION: '18'

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Create test results directory
        run: mkdir -p test-results merged-results

      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL || 'http://localhost:8081/orangehrm-5.7/web/index.php/auth/login' }}
          ENV: local

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  publish-to-xray:
    name: Publish Results to Xray
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    
    outputs:
      test_execution_key: ${{ steps.xray-upload.outputs.test_execution_key }}
      test_execution_url: ${{ steps.xray-upload.outputs.test_execution_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Prepare merged results
        run: |
          mkdir -p merged-results
          if [ -f test-results/junit.xml ]; then
            cp test-results/junit.xml merged-results/junit.xml
          else
            echo "âš ï¸  Warning: junit.xml not found"
            ls -la test-results/
          fi

      - name: Authenticate with Xray
        id: xray-auth
        run: node scripts/xray-authenticate.js
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}

      - name: Upload results to Xray
        id: xray-upload
        run: node scripts/xray-upload.js
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          XRAY_TEST_PLAN_KEY: ${{ secrets.XRAY_TEST_PLAN_KEY }}
          XRAY_TEST_EXECUTION_KEY: ${{ secrets.XRAY_TEST_EXECUTION_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Upload Xray summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xray-summary
          path: test-results/xray-summary.json
          retention-days: 30

  comment-pr:
    name: Comment PR with Results
    if: always() && github.event_name == 'pull_request'
    needs: [publish-to-xray]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test summary
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Download Xray summary
        uses: actions/download-artifact@v4
        with:
          name: xray-summary
          path: test-results
        continue-on-error: true

      - name: Comment PR with test results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary, xraySummary;
            
            try {
              summary = JSON.parse(fs.readFileSync('test-results/summary.json', 'utf8'));
            } catch (e) {
              console.log('Could not read summary.json');
              summary = { total: 0, passed: 0, failed: 0, skipped: 0, successRate: 0 };
            }
            
            try {
              xraySummary = JSON.parse(fs.readFileSync('test-results/xray-summary.json', 'utf8'));
            } catch (e) {
              console.log('Could not read xray-summary.json');
              xraySummary = null;
            }
            
            const emoji = summary.successRate === 100 ? 'ğŸ‰' : summary.successRate >= 80 ? 'âœ…' : 'âš ï¸';
            
            let comment = `## ${emoji} Test Results - Run #${context.runNumber}
            
            | Metric | Value |
            |--------|-------|
            | **Total Tests** | ${summary.total} |
            | âœ… **Passed** | ${summary.passed} |
            | âŒ **Failed** | ${summary.failed} |
            | â­ï¸ **Skipped** | ${summary.skipped} |
            | ğŸ“Š **Success Rate** | ${summary.successRate}% |
            `;
            
            if (xraySummary) {
              comment += `
            ### ğŸ“‹ Xray Integration
            - **Test Execution**: [${xraySummary.testExecutionKey}](${xraySummary.testExecutionUrl})
            - **Updated at**: ${new Date(xraySummary.uploadedAt).toLocaleString()}
            `;
            }
            
            comment += `
            ### ğŸ”— Links
            - [GitHub Actions Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ---
            *Powered by Playwright + Xray + GitHub for Jira*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });